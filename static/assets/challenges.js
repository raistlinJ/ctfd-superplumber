import{m as r,C as l,h as f,T as d,d as w,M as g,a as C}from"./index.js";const u={challenge_category_order:!1,challenge_order:!1};function b(e,{settingKey:t,label:s}){var i,n;if(!Array.isArray(e)||u[t])return e;const a=(n=(i=l)==null?void 0:i.config)==null?void 0:n.themeSettings,c=a==null?void 0:a[t];if(!c)return e;let o;try{o=new Function(`return (${c})`)()}catch(h){return u[t]=!0,console.warn(`[Superplumber Theme] Failed to parse ${s} sort function from theme setting "${t}".`,h),e}if(typeof o!="function")return u[t]=!0,console.warn(`[Superplumber Theme] Theme setting "${t}" must evaluate to a function but returned`,o),e;try{e.sort(o)}catch(h){u[t]=!0,console.warn(`[Superplumber Theme] Theme setting "${t}" threw while sorting ${s}s.`,h)}return e}function S(e){if(!e)return;e.querySelectorAll('a[href*="://"]').forEach(s=>{s.setAttribute("target","_blank"),s.setAttribute("rel","noopener noreferrer")})}function y(e){const t=document.createElement("template");return t.innerHTML=e,S(t.content||t),t.innerHTML}window.Alpine=r;r.store("challenge",{data:{view:""}});r.data("Hint",()=>({id:null,html:null,async showHint(e){if(e.target.open){let t=await l.pages.challenge.loadHint(this.id);if(t.errors){e.target.open=!1,l._functions.challenge.displayUnlockError(t);return}let s=t.data;if(s.content)this.html=y(s.html);else if(await l.pages.challenge.displayUnlock(this.id)){let c=await l.pages.challenge.loadUnlock(this.id);if(c.success){let i=(await l.pages.challenge.loadHint(this.id)).data;this.html=y(i.html)}else e.target.open=!1,l._functions.challenge.displayUnlockError(c)}else e.target.open=!1}}}));r.data("Challenge",()=>({id:null,next_id:null,submission:"",tab:null,solves:[],submissions:[],solution:null,response:null,share_url:null,max_attempts:0,attempts:0,ratingValue:0,hoveredRating:0,selectedRating:0,ratingReview:"",ratingSubmitted:!1,async init(){f()},getStyles(){var t,s;let e={"modal-dialog":!0};try{switch(((s=(t=l.config)==null?void 0:t.themeSettings)==null?void 0:s.challenge_window_size)||"xl"){case"sm":e["modal-sm"]=!0;break;case"lg":e["modal-lg"]=!0;break;case"xl":default:e["modal-xl"]=!0;break}}catch(a){console.log("Error processing challenge_window_size"),console.log(a),e["modal-xl"]=!0}return e},async init(){f()},async showChallenge(){new d(this.$el).show()},async showSolves(){this.solves=await l.pages.challenge.loadSolves(this.id),this.solves.forEach(e=>(e.date=w(e.date).format("MMMM Do, h:mm:ss A"),e)),new d(this.$el).show()},async showSubmissions(){let e=await l.pages.users.userSubmissions("me",this.id);this.submissions=e.data,this.submissions.forEach(t=>(t.date=w(t.date).format("MMMM Do, h:mm:ss A"),t)),new d(this.$el).show()},getSolutionId(){return r.store("challenge").data.solution_id},async showSolution(){let e=this.getSolutionId();l._functions.challenge.displaySolution=t=>{this.solution=t.html,new d(this.$el).show()},await l.pages.challenge.displaySolution(e)},getNextId(){return r.store("challenge").data.next_id},async nextChallenge(){const e=document.querySelector("[x-ref='challengeWindow']");if(!e)return;let t=g.getOrCreateInstance(e);t._element.addEventListener("hidden.bs.modal",s=>{r.nextTick(()=>{this.$dispatch("load-challenge",this.getNextId())})},{once:!0}),t.hide()},async getShareUrl(){let e={type:"solve",challenge_id:this.id};const a=(await(await l.fetch("/api/v1/shares",{method:"POST",body:JSON.stringify(e)})).json()).data.url;this.share_url=a},copyShareUrl(){navigator.clipboard.writeText(this.share_url);let e=C.getOrCreateInstance(this.$el);e.enable(),e.show(),setTimeout(()=>{e.hide(),e.disable()},2e3)},async submitChallenge(){var t,s,a,c,o,i;if(!(((s=(t=l)==null?void 0:t.user)==null?void 0:s.id)!==null&&((c=(a=l)==null?void 0:a.user)==null?void 0:c.id)!==void 0)){this.response={data:{status:"login_required",message:"Please log in to submit flags."}},await this.renderSubmissionResponse();return}try{const n=await l.pages.challenge.submitChallenge(this.id,this.submission);this.response=this.normalizeSubmissionResponse(n)}catch(n){console.error("Challenge submission failed",n),this.response={data:{status:"error",message:((i=(o=n==null?void 0:n.response)==null?void 0:o.data)==null?void 0:i.message)||(n==null?void 0:n.message)||"Something went wrong. Please try again."}}}await this.renderSubmissionResponse()},async renderSubmissionResponse(){var t;const e=(t=this.response)==null?void 0:t.data;!e||(e.status==="correct"&&(this.submission=""),this.max_attempts>0&&e.status!="already_solved"&&e.status!="ratelimited"&&(this.attempts+=1),this.$dispatch("load-challenges"))},normalizeSubmissionResponse(e){if(!e||typeof e!="object")return{data:{status:"error",message:"No response received."}};const t=e.success?"correct":"incorrect",s=e.data&&typeof e.data=="object"?e.data:{};return{...e,data:{status:s.status||t,message:s.message||e.message||(e.success?"Challenge solved!":"Submission received.")}}},async submitRating(){(await l.pages.challenge.submitRating(this.id,this.selectedRating,this.ratingReview)).value?(this.ratingValue=this.selectedRating,this.ratingSubmitted=!0):alert("Error submitting rating")}}));r.data("ChallengeBoard",()=>({loaded:!1,challenges:[],challenge:null,scrollCueCleanup:null,async init(){if(this.challenges=await l.pages.challenges.getChallenges(),this.loaded=!0,this.$nextTick(()=>{this.setupScrollHint()}),window.location.hash){let e=decodeURIComponent(window.location.hash.substring(1)),t=e.lastIndexOf("-");if(t>=0){let a=[e.slice(0,t),e.slice(t+1)][1];await this.loadChallenge(a)}}},getCategories(){const e=[];return this.challenges.forEach(t=>{const{category:s}=t;e.includes(s)||e.push(s)}),b(e,{settingKey:"challenge_category_order",label:"challenge category"}),e},getChallenges(e){let t=this.challenges;return e!==null&&(t=this.challenges.filter(s=>s.category===e)),b(t,{settingKey:"challenge_order",label:"challenge"}),t},async loadChallenges(){this.challenges=await l.pages.challenges.getChallenges(),this.$nextTick(()=>{this.setupScrollHint()})},async loadChallenge(e){await l.pages.challenge.displayChallenge(e,t=>{const s=r.store("challenge");s.data={...t.data,view:""},r.nextTick(()=>{s.data.view=t.data.view,r.nextTick(async()=>{var n;const a=((n=this.$refs)==null?void 0:n.challengeWindow)||document.querySelector("[x-ref='challengeWindow']");if(!a)return;await(()=>new Promise(h=>{const m=p=>{if(a.querySelector(".modal-dialog")){h();return}if(p<=0){console.warn("Bootstrap modal dialog markup not found yet; skipping show()"),h();return}requestAnimationFrame(()=>m(p-1))};m(10)}))();const o=g.getInstance(a);o&&o.dispose();const i=new g(a);i._element.addEventListener("hidden.bs.modal",()=>{history.replaceState(null,null," ")},{once:!0}),S(i._element),i.show(),history.replaceState(null,null,`#${t.data.name}-${e}`)})})})},setupScrollHint(){this.scrollCueCleanup&&(this.scrollCueCleanup(),this.scrollCueCleanup=null);const e=document.querySelector(".superplumber-world-columns");if(!e)return;const t=()=>{if(!(e.scrollWidth-e.clientWidth>8)){e.classList.remove("has-scroll");return}const i=e.scrollLeft+e.clientWidth>=e.scrollWidth-16;e.classList.toggle("has-scroll",!i)},s=()=>{t()};e.addEventListener("scroll",s,{passive:!0});const a=new ResizeObserver(()=>t());a.observe(e),this.scrollCueCleanup=()=>{e.removeEventListener("scroll",s),a.disconnect()},t()}}));
